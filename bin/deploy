#!/usr/bin/env sh

# functions
function loadTitles() {
    read -r -d '' TITLE_ENCRYPTED <<OUTOUT
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ VERIFY ENCRYPTED PROPERTIES                                                  ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
OUTOUT
    read -r -d '' TITLE_CONFIG <<OUTOUT
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ NORMALIZE ENVIRONMENT CONFIGURATION                                          ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
OUTOUT
    read -r -d '' TITLE_DUMP <<OUTOUT
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ CACHING DI CONTAINER                                                         ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
OUTOUT
    read -r -d '' TITLE_DOCTRINE <<OUTOUT
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ CACHING DOCTRINE PROXIES                                                     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
OUTOUT
    read -r -d '' TITLE_CLEANUP <<OUTOUT
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ CLEAN UP                                                                     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
OUTOUT
}

function removeArtifacts() {
    DELFILES=(
        "bin/composer"
        "testing"
    )

    # Remove files
    for i in ${DELFILES[@]}
    do
        FILE="$DIR/../$i"
        EXISTS=$(test -e $FILE && echo 1 || echo 0)
        if [[ $EXISTS -eq "1" ]]; then
            echo "Removing $FILE"
            rm -rf "$FILE"
        fi

    done
}

# setup

DIR=$( cd "$( dirname "$0" )" && pwd )
loadTitles
DEPLOY=false

set -e

# determine whether to run frontend or backend only install
for var in "$@" ; do
    if [ "$var" = "--deploy" ] ; then
        DEPLOY=true
    fi
done

# install and configure
echo "$TITLE_ENCRYPTED"
"$DIR"/verify-encrypted

echo "$TITLE_CONFIG"
"$DIR"/normalize-configuration

echo "$TITLE_DUMP"
"$DIR"/dump-di

echo "$TITLE_DOCTRINE"
"$DIR"/generate-doctrine-proxies

# Remove artifacts from deployment - keep your builds tidy!
if [ "$DEPLOY" = true ] ; then
    echo "$TITLE_CLEANUP"
    removeArtifacts "bin/composer" "testing"
fi
