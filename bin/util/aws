#!/usr/bin/env php
<?php

namespace Hal\Bin;

use Aws\Sdk;

define('AWS_SCRIPT_PATH', '/bin/util/aws-scripts/%s.php');

$root = realpath(__DIR__ . '/../..');
require_once "${root}/vendor/autoload.php";

// Parse arguments

array_shift($argv);
if (!$argv) {

    echo "ERROR: No command specified. Please provide a script to run.\n\n";
    echo "Example: bin/util/aws ec2\n";
    echo '         (runs $project' . sprintf(AWS_SCRIPT_PATH, 'ec2') . ")\n";

    exit(1);
}

$script = array_shift($argv);
$scriptFile = $root . sprintf(AWS_SCRIPT_PATH, $script);
if (!file_exists($scriptFile)) {
    echo "ERROR: Script not found.\n\n";
    exit(1);
}

// Run script

$key = getenv('AWS_KEY');
$secret = getenv('AWS_SECRET');
$region = getenv('AWS_REGION') ?: 'us-east-1';

$aws = new Sdk(['version' => 'latest']);

$config = [
    'region' => $region,
    'credentials' => ['key' => $key, 'secret' => $secret]
];

require $scriptFile;

// Output

var_dump($result);

$output = json_encode($result->toArray(), JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES);
file_put_contents(__DIR__ . '/aws-scripts/aws.log.json', $output);
