services:

    # imported from global scope
    # @doctrine.em
    # @repository.repo
    # @environment.repo
    # @user.repo
    # @deployment.repo
    # @push.repo
    # @mcp-logger
    # @mcp-logger.factory

    # %agent.environment.archive%
    # %agent.environment.path%
    # %agent.environment.temp%
    # %agent.environment.home%
    # %agent.ssh-user%
    # %github.token%
    # %mcp-logger.host%
    application:
        scope: 'agent'
        class: 'Symfony\Component\Console\Application'
        arguments:
            - '%agent.application.name%'
            - '%agent.application.version%'
        calls:
            # Every one of these commands is instantiated regardless of the running command
            # There is no way to lazy load these without significant jankiness
            - ['add', ['@command.build.create']]
            - ['add', ['@command.build.build']]
            - ['add', ['@command.build.remove']]
            - ['add', ['@command.push.create']]
            - ['add', ['@command.push.push']]
            - ['add', ['@command.builds.list']]
            - ['add', ['@command.worker.build']]
            - ['add', ['@command.worker.push']]
            - ['setDispatcher', ['@dispatcher']]
    dispatcher:
        scope: 'agent'
        class: 'Symfony\Component\EventDispatcher\EventDispatcher'
        calls:
            - ['addSubscriber', ['@mcp-logger.factory.subscriber']]

    clock:
        scope: 'agent'
        class: 'MCP\DataType\Time\Clock'
        arguments: ['now', 'UTC']

    # commands
    command.build.create:
        scope: 'agent'
        class: 'QL\Hal\Agent\Command\CreateBuildCommand'
        arguments:
            - 'build:create'
            - '@doctrine.em'
            - '@clock'
            - '@repository.repo'
            - '@environment.repo'
            - '@user.repo'
            - '@utility.reference-resolver'
    command.build.build:
        scope: 'agent'
        class: 'QL\Hal\Agent\Command\BuildCommand'
        arguments:
            - 'build:build'
            - '@utility.logger'
            - '@doctrine.em'
            - '@clock'
            - '@build.resolver'
            - '@build.downloader'
            - '@build.unpacker'
            - '@build.builder'
            - '@build.packer'
            - '@utility.helper.download-progress'
            - '@utility.process.builder=' # = signifies a prototype service
    command.build.remove:
        scope: 'agent'
        class: 'QL\Hal\Agent\Command\RemoveBuildCommand'
        arguments:
            - 'build:remove'
            - '@doctrine.em'
            - '@build.repo'
            - '@utility.filesystem'
            - '%agent.environment.archive%'
    command.builds.list:
        scope: 'agent'
        class: 'QL\Hal\Agent\Command\ListBuildsCommand'
        arguments:
            - 'builds:list'
            - '@build.repo'
            - '@utility.filesystem'
            - '%agent.environment.archive%'
    command.push.create:
        scope: 'agent'
        class: 'QL\Hal\Agent\Command\CreatePushCommand'
        arguments:
            - 'push:create'
            - '@doctrine.em'
            - '@clock'
            - '@build.repo'
            - '@deployment.repo'
            - '@user.repo'
    command.push.push:
        scope: 'agent'
        class: 'QL\Hal\Agent\Command\PushCommand'
        arguments:
            - 'push:push'
            - '@utility.logger'
            - '@doctrine.em'
            - '@clock'
            - '@push.resolver'
            - '@push.unpacker'
            - '@push.pusher'
            - '@push.server-command'
            - '@utility.process.builder=' # = signifies a prototype service
    command.worker.build:
        scope: 'agent'
        class: 'QL\Hal\Agent\Command\Worker\BuildCommand'
        arguments:
            - 'worker:build'
            - 'build:build'
            - '@build.repo'
            - '@doctrine.em'
            - '@utility.forker'
    command.worker.push:
        scope: 'agent'
        class: 'QL\Hal\Agent\Command\Worker\PushCommand'
        arguments:
            - 'worker:push'
            - 'push:push'
            - '@push.repo'
            - '@doctrine.em'
            - '@utility.forker'

    # utility
    utility.helper.download-progress:
        scope: 'agent'
        class: 'QL\Hal\Agent\Helper\DownloadProgressHelper'
        arguments:
            - '@github.guzzleHttpClient'
    utility.yaml-dumper:
        scope: 'agent'
        class: 'Symfony\Component\Yaml\Dumper'
        calls:
            - ['setIndentation', ['4']]
    utility.logger:
        scope: 'agent'
        class: 'QL\Hal\Agent\Helper\MemoryLogger'
        calls:
            - ['setBufferedLogger', ['@mcp-logger']]
    utility.filesystem:
        scope: 'agent'
        class: 'Symfony\Component\Filesystem\Filesystem'

    utility.process.builder:
        scope: 'agent'
        class: 'Symfony\Component\Process\ProcessBuilder'
        scope: prototype
        calls:
            - ['inheritEnvironmentVariables', [false]]
    utility.reference-resolver:
        scope: 'agent'
        class: 'QL\Hal\Agent\Github\ReferenceResolver'
        arguments:
            - '@github.references'
            - '@github.commits'
            - '@github.pull-requests'
    utility.forker:
        scope: 'agent'
        class: 'QL\Hal\Agent\Helper\ForkHelper'

    # build actions
    build.resolver:
        scope: 'agent'
        class: 'QL\Hal\Agent\Build\Resolver'
        arguments:
            - '@utility.logger'
            - '@build.repo'
            - '%agent.environment.path%'
            - '%agent.environment.archive%'
        calls:
            - ['setBaseBuildDirectory', ['%agent.environment.temp%']]
            - ['setHomeDirectory', ['%agent.environment.home%']]
    build.downloader:
        scope: 'agent'
        class: 'QL\Hal\Agent\Build\Downloader'
        arguments:
            - '@utility.logger'
            - '@github.archive'
    build.unpacker:
        scope: 'agent'
        class: 'QL\Hal\Agent\Build\Unpacker'
        arguments:
            - '@utility.logger'
            - '@utility.process.builder=' # = signifies a prototype service
    build.builder:
        scope: 'agent'
        class: 'QL\Hal\Agent\Build\Builder'
        arguments:
            - '@utility.logger'
            - '@utility.process.builder=' # = signifies a prototype service
    build.packer:
        scope: 'agent'
        class: 'QL\Hal\Agent\Build\Packer'
        arguments:
            - '@utility.logger'
            - '@utility.process.builder=' # = signifies a prototype service

    # push actions
    push.resolver:
        scope: 'agent'
        class: 'QL\Hal\Agent\Push\Resolver'
        arguments:
            - '@utility.logger'
            - '@push.repo'
            - '@clock'
            - '%agent.ssh-user%'
            - '%agent.environment.archive%'
        calls:
            - ['setBaseBuildDirectory', ['%agent.environment.temp%']]
    push.unpacker:
        scope: 'agent'
        class: 'QL\Hal\Agent\Push\Unpacker'
        arguments:
            - '@utility.logger'
            - '@utility.process.builder=' # = signifies a prototype service
            - '@utility.filesystem'
            - '@utility.yaml-dumper'
    push.pusher:
        scope: 'agent'
        class: 'QL\Hal\Agent\Push\Pusher'
        arguments:
            - '@utility.logger'
            - '@utility.process.builder=' # = signifies a prototype service
    push.server-command:
        scope: 'agent'
        class: 'QL\Hal\Agent\Push\ServerCommand'
        arguments:
            - '@utility.logger'
            - '@utility.process.builder=' # = signifies a prototype service
            - '%agent.ssh-user%'

    # github services
    github.archive:
        scope: 'agent'
        class: 'QL\Hal\Agent\Github\ArchiveApi'
        arguments:
            - '@github.client'
            - '@utility.filesystem'
    github.references:
        scope: 'agent'
        class: 'Github\Api\GitData\References'
        arguments:
            - '@github.client'
    github.commits:
        scope: 'agent'
        class: 'Github\Api\GitData\Commits'
        arguments:
            - '@github.client'
    github.pull-requests:
        scope: 'agent'
        class: 'Github\Api\PullRequest'
        arguments:
            - '@github.client'

    github.client:
        scope: 'agent'
        class: 'Github\Client'
        arguments: ['@github.httpClient']
    github.httpClient:
        scope: 'agent'
        class: 'Github\HttpClient\HttpClient'
        arguments: [[], '@github.guzzleHttpClient']
        calls:
            - ['authenticate', ['%github.token%', null, 'http_token']]
    github.guzzleHttpClient:
        scope: 'agent'
        class: 'Guzzle\Http\Client'
        arguments:
            - '%github.baseurl%'
            -
                curl.options:
                    progress: true

    # logger services
    mcp-logger.factory.subscriber:
        scope: 'agent'
        class: 'QL\Hal\Agent\Helper\McpLoggerSetupSubscriber'
        arguments: ['@mcp-logger.factory']
