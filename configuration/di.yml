imports:
    - resource: 'di.command.yml'
    - resource: 'di.build.yml'
    - resource: 'di.push.yml'
    - resource: 'services/services.doctrine.yml'
    - resource: 'services/services.github.yml'

services:

    root:
        synthetic: true

    application:
        class: 'Symfony\Component\Console\Application'
        arguments: ['%application.name%', '%application.version%']
        calls:
            - ['add', ['@command.management.build.create']]
            - ['add', ['@command.management.build.start']]
            - ['add', ['@command.management.release.create']]
            - ['add', ['@command.management.release.start']]
            - ['add', ['@command.runner.build']]
            - ['add', ['@command.runner.deploy']]
            # - ['add', ['@lazy.command.build.remove']]
            # - ['add', ['@lazy.command.builds.list']]
            - ['add', ['@command.worker.build']]
            - ['add', ['@command.worker.deploy']]
            - ['add', ['@command.docker.refresh']]
            - ['add', ['@command.docker.status']]
            - ['setDispatcher', ['@dispatcher']]
    dispatcher:
        class: 'Symfony\Component\EventDispatcher\EventDispatcher'
        calls:
            - ['addSubscriber', ['@logger.mcp.subscriber']]
            - ['addSubscriber', ['@logger.exception_handler']]

    clock:
        class: 'QL\MCP\Common\Time\Clock'
        arguments: ['now', 'UTC']

    ssh.manager:
        class: 'Hal\Agent\Remoting\SSHSessionManager'
        arguments: ['@logger.event', '@ssh.wallet']

    ssh.filemanager:
        class: 'Hal\Agent\Remoting\FileSyncManager'
        arguments: ['@ssh.wallet']

    ssh.wallet:
        class: 'Hal\Agent\Remoting\CredentialWallet'
        calls:
            - ['importCredentials', ['%ssh.credentials%']]

    redis:
        class: 'Predis\Client'
        arguments:
            - '%redis.server%'
            - {prefix: '%redis.prefix%:'}

    ####################################################################################################################
    # logging
    ####################################################################################################################

    logger:
        parent: 'mcp.logger'

    logger.exception_handler:
        class: 'Hal\Agent\Symfony\ExceptionHandlerSubscriber'
        arguments: ['@logger']
        calls:
            - ['setStacktraceLogging', ['%logging.stacktrace%']]

    logger.event:
        class: 'Hal\Agent\Logger\EventLogger'
        arguments:
            - '@doctrine.em'
            - '@logger.event.factory'
            - '@logger.process.handler'
            - '@clock'
    logger.event.factory:
        class: 'Hal\Agent\Logger\EventFactory'
        arguments: ['@doctrine.em', '@doctrine.random']
        calls:
            - ['setRedisHandler', ['@redis']]

    logger.process.handler:
        class: 'Hal\Agent\Logger\ProcessHandler'
        arguments: ['@doctrine.em', '@utility.id.generator']

    # subscriber to symfony/console event system to prepare mcp logger
    logger.mcp.subscriber:
        class: 'Hal\Agent\Logger\MCPLoggerSubscriber'
        arguments: ['@mcp.logger.factory']

    ####################################################################################################################
    # utility / shared
    ####################################################################################################################

    utility.filesystem:
        class: 'Symfony\Component\Filesystem\Filesystem'
    utility.process.builder:
        class: 'Symfony\Component\Process\ProcessBuilder'
        shared: false
        calls:
            - ['inheritEnvironmentVariables', [false]]
    utility.referenceResolver:
        class: 'Hal\Agent\Github\ReferenceResolver'
        arguments:
            - '@github.references'
            - '@github.commits'
            - '@github.pullRequests'
    utility.forker:
        class: 'Hal\Agent\Helper\ForkHelper'

    utility.id.generator:
        class: 'QL\Hal\Core\JobIdGenerator'
        arguments:
            - '%application.major.version%'
            - '%unique.alphabet%'
            - '%unique.size%'

    yaml.parser:
        class: 'Symfony\Component\Yaml\Parser'

    utility.environment.resolver:
        class: 'Hal\Agent\Utility\BuildEnvironmentResolver'
        arguments: ['@utility.process.builder']
        calls:
            - ['setWindowsBuilder', ['%build.windows.remoteUser%', '%build.windows.server%', '%build.windows.temp%']]
            - ['setUnixBuilder', ['%build.unix.remoteUser%', '%build.unix.server%', '%build.unix.temp%']]

    aws:
        class: 'Aws\Sdk'
        arguments:
            -
                version: latest

    ####################################################################################################################
    # encryption
    ####################################################################################################################

    encrypter.factory:
        class: 'QL\Hal\Core\Crypto\CryptoFactory'
        arguments: ['@encrypter.encryptedkey.squished', '%encrypter.symmetricKeyPath%']

    decrypter:
        class: 'QL\Hal\Core\Crypto\Decrypter'
        factory: ['@encrypter.factory', 'getAsymmetricDecrypter']

    encrypter.encryptedkey.squished:
        class: 'DERP'
        factory: ['Hal\Agent\Utility\Stringify', 'squish']
        arguments: ['%encrypter.encryptedkey%']

    encrypted.resolver:
        class: 'Hal\Agent\Utility\EncryptedPropertyResolver'
        arguments:
            - '@doctrine.em'
            - '@logger.event'
            - '@service_container'
