services:

    application:
        class: 'Symfony\Component\Console\Application'
        arguments:
            - '%application.name%'
            - '%application.version%'
        calls:
            - ['add', ['@command.build.create']]
            - ['add', ['@command.build.build']]
            - ['add', ['@command.push.create']]
            - ['add', ['@command.push.push']]

    clock:
        class: 'MCP\DataType\Time\Clock'
        arguments: ['now', 'UTC']

    command.build.create:
        class: 'QL\Hal\Agent\Command\CreateBuildCommand'
        arguments:
            - 'build:create'
            - '@doctrine.em'
            - '@clock'
            - '@repo.repository'
            - '@repo.environment'
    command.build.build:
        class: 'QL\Hal\Agent\Command\BuildCommand'
        arguments:
            - 'build:build'
            - '@utility.logger'
            - '@doctrine.em'
            - '@clock'
            - '@build.resolver'
            - '@build.downloader'
            - '@build.unpacker'
            - '@build.builder'
            - '@build.packer'
            - '@utility.helper.download-progress'
            - '@process.builder=' # = signifies a prototype service
    command.push.create:
        class: 'QL\Hal\Agent\Command\CreatePushCommand'
        arguments:
            - 'push:create'
            - '@doctrine.em'
            - '@clock'
            - '@repo.build'
            - '@repo.deployment'
    command.push.push:
        class: 'QL\Hal\Agent\Command\PushCommand'
        arguments:
            - 'push:push'
            - '@utility.logger'
            - '@doctrine.em'
            - '@clock'
            - '@push.resolver'
            - '@push.unpacker'
            - '@push.pusher'
            - '@push.server-command'
            - '@process.builder=' # = signifies a prototype service

    utility.helper.download-progress:
        class: 'QL\Hal\Agent\Helper\DownloadProgressHelper'
        arguments:
            - '@github.guzzleHttpClient'
    utility.yaml-dumper:
        class: 'Symfony\Component\Yaml\Dumper'
        calls:
            - ['setIndentation', ['4']]
    utility.logger:
        class: 'QL\Hal\Agent\Helper\MemoryLogger'
    utility.filesystem:
        class: 'Symfony\Component\Filesystem\Filesystem'

    build.resolver:
        class: 'QL\Hal\Agent\Build\Resolver'
        arguments:
            - '@utility.logger'
            - '@repo.build'
            - '%environment.path%'
            - '%environment.archive%'
        calls:
            - ['setBaseBuildDirectory', ['%environment.temp%']]
            - ['setHomeDirectory', ['%environment.home%']]
    build.downloader:
        class: 'QL\Hal\Agent\Build\Downloader'
        arguments:
            - '@utility.logger'
            - '@github.archive'
    build.unpacker:
        class: 'QL\Hal\Agent\Build\Unpacker'
        arguments:
            - '@utility.logger'
            - '@process.builder=' # = signifies a prototype service
    build.builder:
        class: 'QL\Hal\Agent\Build\Builder'
        arguments:
            - '@utility.logger'
            - '@process.builder=' # = signifies a prototype service
    build.packer:
        class: 'QL\Hal\Agent\Build\Packer'
        arguments:
            - '@utility.logger'
            - '@process.builder=' # = signifies a prototype service

    process.builder:
        class: 'Symfony\Component\Process\ProcessBuilder'
        scope: prototype
        calls:
            - ['inheritEnvironmentVariables', [false]]

    push.resolver:
        class: 'QL\Hal\Agent\Push\Resolver'
        arguments:
            - '@utility.logger'
            - '@repo.push'
            - '@clock'
            - '%ssh-user%'
            - '%environment.archive%'
        calls:
            - ['setBaseBuildDirectory', ['%environment.temp%']]
    push.unpacker:
        class: 'QL\Hal\Agent\Push\Unpacker'
        arguments:
            - '@utility.logger'
            - '@process.builder=' # = signifies a prototype service
            - '@utility.filesystem'
            - '@utility.yaml-dumper'
    push.pusher:
        class: 'QL\Hal\Agent\Push\Pusher'
        arguments:
            - '@utility.logger'
            - '@process.builder=' # = signifies a prototype service
    push.server-command:
        class: 'QL\Hal\Agent\Push\ServerCommand'
        arguments:
            - '@utility.logger'
            - '@process.builder=' # = signifies a prototype service
            - '%ssh-user%'

### imported from hal-core

    # Repositories
    repo.build:
        class: 'QL\Hal\Core\Entity\Repository\BuildRepository'
        factory_service:  doctrine.em
        factory_method:   getRepository
        arguments:
            - 'QL\Hal\Core\Entity\Build'
    repo.deployment:
        class: 'QL\Hal\Core\Entity\Repository\DeploymentRepository'
        factory_service:  doctrine.em
        factory_method:   getRepository
        arguments:
            - 'QL\Hal\Core\Entity\Deployment'
    repo.environment:
        class: 'QL\Hal\Core\Entity\Repository\EnvironmentRepository'
        factory_service:  doctrine.em
        factory_method:   getRepository
        arguments:
            - 'QL\Hal\Core\Entity\Environment'
    repo.push:
        class: 'QL\Hal\Core\Entity\Repository\PushRepository'
        factory_service:  doctrine.em
        factory_method:   getRepository
        arguments:
            - 'QL\Hal\Core\Entity\Push'
    repo.repository:
        class: 'QL\Hal\Core\Entity\Repository\RepositoryRepository'
        factory_service:  doctrine.em
        factory_method:   getRepository
        arguments:
            - 'QL\Hal\Core\Entity\Repository'

    # Doctrine Configuration
    doctrine.config:
        class:            'Doctrine\ORM\Configuration'
        factory_class:    'Doctrine\ORM\Tools\Setup'
        factory_method:   createAnnotationMetadataConfiguration
        arguments:
            - %doctrine.mappings%
            - %doctrine.devmode%

    # Doctrine Entity Manager Configurator
    doctrine.em.config:
        class: 'QL\Hal\Core\Entity\Configurator\EntityManagerConfigurator'

    # Doctrine Entity Manager
    doctrine.em:
        class:            'Doctrine\ORM\EntityManager'
        factory_class:    'Doctrine\ORM\EntityManager'
        factory_method:   create
        arguments:
            - %doctrine.connection%
            - @doctrine.config
        configurator: ['@doctrine.em.config', 'configure']

### imported from hal

    github.archive:
        class: 'QL\Hal\Agent\Github\ArchiveApi'
        arguments: ['@github.client']
    github.client:
        class: 'Github\Client'
        arguments: ['@github.httpClient']
    github.httpClient:
        class: 'Github\HttpClient\HttpClient'
        arguments: [[], '@github.guzzleHttpClient']
        calls:
            - ['authenticate', ['%github.token%', null, 'http_token']]
    github.guzzleHttpClient:
        class: 'Guzzle\Http\Client'
        arguments:
            - 'http://git/api/v3/'
            -
                curl.options:
                    progress: true
